name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: franciscothiesen/mirror_bridge

jobs:
  # ============================================================================
  # Clang-based tests (Bloomberg's clang-p2996 fork)
  # ============================================================================
  test-python:
    name: Python Bindings (Clang)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/franciscothiesen/mirror_bridge:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify reflection support
        run: |
          echo '#include <meta>' > /tmp/test.cpp
          echo 'int main() { return 0; }' >> /tmp/test.cpp
          clang++ -std=c++2c -freflection -stdlib=libc++ /tmp/test.cpp -o /tmp/test
          echo "✓ Reflection support verified"

      - name: Run Python tests
        run: |
          # Build and test Vec3 static method test
          echo "=== Building Vec3 test ==="
          cd tests/static_method_test
          ./build_vec3_test.sh

          echo ""
          echo "=== Running Vec3 tests ==="
          python3 test_vec3.py

      - name: Run full test suite
        run: |
          ./tests/run_all_tests.sh

  test-lua:
    name: Lua Bindings (Clang)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/franciscothiesen/mirror_bridge:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Lua is installed
        run: |
          lua5.4 -v || (echo "Lua 5.4 not found" && exit 1)
          echo "✓ Lua 5.4 available"

      - name: Run Lua tests
        run: |
          cd tests/lua/static_method_test
          ./build_and_test.sh

  test-javascript:
    name: JavaScript Bindings - Node.js (Clang)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/franciscothiesen/mirror_bridge:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Node.js is installed
        run: |
          node --version || (echo "Node.js not found" && exit 1)
          npm --version || (echo "npm not found" && exit 1)
          echo "✓ Node.js and npm available"

      - name: Run JavaScript tests
        run: |
          cd tests/js/static_method_test
          ./build_and_test.sh

  # ============================================================================
  # V8 Direct API Tests (Embedded V8, separate from Node.js)
  # ============================================================================
  test-v8:
    name: JavaScript Bindings - V8 Direct (Clang)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/franciscothiesen/mirror_bridge:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify V8 development files
        run: |
          if [ -f "/usr/include/v8.h" ] || pkg-config --exists v8 2>/dev/null; then
            echo "✓ V8 development files available"
          else
            echo "✗ V8 development files not found"
            exit 1
          fi

      - name: Build and run V8 tests
        run: |
          # V8 tests are built and run by the test runner
          # They compile C++ executables that embed V8 and run JS tests
          mkdir -p build

          # Set up environment
          export LD_LIBRARY_PATH=/usr/local/lib/aarch64-unknown-linux-gnu:/usr/local/lib/x86_64-unknown-linux-gnu:$LD_LIBRARY_PATH

          # Find V8 compile flags
          if pkg-config --exists v8 2>/dev/null; then
            V8_CFLAGS=$(pkg-config --cflags v8)
            V8_LIBS=$(pkg-config --libs v8)
          else
            V8_CFLAGS="-I/usr/include"
            V8_LIBS="-lv8 -lv8_libplatform"
          fi

          CXX_FLAGS="-std=c++2c -freflection -freflection-latest -stdlib=libc++"

          # Build and run each V8 test
          for test_dir in tests/v8/*/; do
            [ -d "$test_dir" ] || continue

            # Handle nested directories (e.g., tests/v8/basic/point2d/)
            for sub_dir in "$test_dir" "$test_dir"/*/; do
              [ -f "$sub_dir/main.cpp" ] || continue

              test_name=$(basename "$sub_dir")
              echo "=== Building V8 test: $test_name ==="

              cd "$sub_dir"
              clang++ $CXX_FLAGS -I../../../.. -I. $V8_CFLAGS main.cpp -o test_executable $V8_LIBS

              echo "=== Running V8 test: $test_name ==="
              ./test_executable test.js

              cd - > /dev/null
              echo ""
            done
          done

  # ============================================================================
  # GCC-based tests (Marek Polacek's GCC reflection branch)
  # This tests compatibility with GCC's P2996 implementation
  # ============================================================================
  # KNOWN ISSUE: GCC's P2996 implementation currently handles pack expansion
  # with reflection splicers differently than Clang. Specifically, patterns like:
  #   std::remove_cvref_t<typename [:get_param_type<T, Is>():]>...
  # fail with "contains no parameter packs" because GCC doesn't recognize the
  # pack parameter inside the splicer. This is a fundamental difference between
  # the two experimental implementations. We expect this to be resolved as GCC's
  # reflection support matures. See: python/mirror_bridge_python.hpp
  # ============================================================================
  test-gcc-python:
    name: Python Bindings (GCC)
    runs-on: ubuntu-latest
    # Allow this job to fail since GCC reflection is experimental and has
    # known incompatibilities with our pack expansion patterns
    continue-on-error: true
    container:
      image: ghcr.io/franciscothiesen/mirror_bridge-gcc:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify GCC reflection support
        run: |
          echo "GCC version:"
          g++ --version
          echo ""
          echo '#include <meta>' > /tmp/test.cpp
          echo 'int main() { return 0; }' >> /tmp/test.cpp
          g++ -std=c++26 -freflection /tmp/test.cpp -o /tmp/test
          echo "✓ GCC reflection support verified"

      - name: Run full test suite with GCC
        run: |
          # The test script auto-detects GCC vs Clang and uses appropriate flags
          ./tests/run_all_tests.sh
